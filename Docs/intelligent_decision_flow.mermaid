flowchart TD
    START([📄 Document Input]) --> ANALYZE[🔍 Document Analysis]
    
    ANALYZE --> TYPE{📋 Document Type?}
    
    %% Question Paper Path
    TYPE -->|Question Paper| QTYPE[📄 Structured Text<br/>Mathematical Content]
    QTYPE --> QCHECK{🖼️ Image Quality?}
    QCHECK -->|High Quality| QOPENAI[🔵 Select OpenAI<br/>Superior precision for<br/>structured content]
    QCHECK -->|Medium/Low| QGEMINI[🟢 Select Gemini<br/>Better noise handling]
    
    %% Answer Sheet Path  
    TYPE -->|Answer Sheet| ATYPE[✍️ Handwritten Content<br/>Multiple Pages]
    ATYPE --> ACHECK{📏 File Size & Pages?}
    ACHECK -->|Large Files<br/>>10 pages| AGEMINI[🟢 Select Gemini<br/>Faster processing<br/>Cost effective]
    ACHECK -->|Small Files<br/>Complex Writing| AOPENAI[🔵 Select OpenAI<br/>Better precision<br/>for complex handwriting]
    
    %% Processing Attempts
    QOPENAI --> PROCESS1[🚀 Primary Processing]
    QGEMINI --> PROCESS1
    AGEMINI --> PROCESS1  
    AOPENAI --> PROCESS1
    
    PROCESS1 --> VALIDATE1{✅ Output Valid?}
    
    %% Success Path
    VALIDATE1 -->|✅ Success| SUCCESS[🎉 Generated Valid Output]
    
    %% First Retry Path
    VALIDATE1 -->|❌ Failed| RETRY1{🔄 Retry Available?}
    RETRY1 -->|Yes| SWITCH1[🔄 Switch AI Model<br/>OpenAI ↔ Gemini]
    SWITCH1 --> PROCESS2[🚀 Secondary Processing<br/>Enhanced Prompts]
    
    PROCESS2 --> VALIDATE2{✅ Output Valid?}
    VALIDATE2 -->|✅ Success| SUCCESS
    
    %% Second Retry Path  
    VALIDATE2 -->|❌ Failed| RETRY2{🔄 Enhanced Methods?}
    RETRY2 -->|Yes| ENHANCED[🔧 Enhanced Processing<br/>Simplified Prompts<br/>Better Preprocessing]
    ENHANCED --> PROCESS3[🚀 Enhanced Processing]
    
    PROCESS3 --> VALIDATE3{✅ Output Valid?}
    VALIDATE3 -->|✅ Success| SUCCESS
    
    %% Fallback Path
    VALIDATE3 -->|❌ Failed| FALLBACK[🛡️ Structured Fallback<br/>Create Professional Document<br/>Include Available Content]
    RETRY1 -->|No| FALLBACK
    RETRY2 -->|No| FALLBACK
    
    FALLBACK --> GUARANTEED[📄 Guaranteed PDF Output<br/>With Diagnostic Information]
    
    %% Final Output
    SUCCESS --> OUTPUT[📊 Display Results<br/>3-Panel View<br/>Download Options]
    GUARANTEED --> OUTPUT
    
    %% Error Logging Throughout
    VALIDATE1 -.-> LOG[📝 Log Performance<br/>Track Success Rates<br/>Model Effectiveness]
    VALIDATE2 -.-> LOG
    VALIDATE3 -.-> LOG
    
    %% Model Selection Factors (Side Info)
    subgraph "🧠 Selection Factors"
        FACTORS[📊 File Size: MB<br/>📏 Pages: Count<br/>🎨 Quality: Low/Med/High<br/>📝 Type: Question/Answer<br/>🧩 Complexity: Simple/Complex<br/>💰 Cost: Optimization]
    end
    
    ANALYZE -.-> FACTORS
    
    %% Styling
    style START fill:#e1f5fe
    style ANALYZE fill:#e8f5e8
    style SUCCESS fill:#c8e6c9
    style GUARANTEED fill:#fff3e0
    style OUTPUT fill:#f3e5f5
    style FALLBACK fill:#ffecb3
    style LOG fill:#fce4ec
    
    %% Model selection styling
    style QOPENAI fill:#e3f2fd
    style AOPENAI fill:#e3f2fd
    style QGEMINI fill:#e8f5e8
    style AGEMINI fill:#e8f5e8
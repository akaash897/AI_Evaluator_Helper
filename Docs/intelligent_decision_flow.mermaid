flowchart TD
    START([ğŸ“„ Document Input]) --> ANALYZE[ğŸ” Document Analysis]
    
    ANALYZE --> TYPE{ğŸ“‹ Document Type?}
    
    %% Question Paper Path
    TYPE -->|Question Paper| QTYPE[ğŸ“„ Structured Text<br/>Mathematical Content]
    QTYPE --> QCHECK{ğŸ–¼ï¸ Image Quality?}
    QCHECK -->|High Quality| QOPENAI[ğŸ”µ Select OpenAI<br/>Superior precision for<br/>structured content]
    QCHECK -->|Medium/Low| QGEMINI[ğŸŸ¢ Select Gemini<br/>Better noise handling]
    
    %% Answer Sheet Path  
    TYPE -->|Answer Sheet| ATYPE[âœï¸ Handwritten Content<br/>Multiple Pages]
    ATYPE --> ACHECK{ğŸ“ File Size & Pages?}
    ACHECK -->|Large Files<br/>>10 pages| AGEMINI[ğŸŸ¢ Select Gemini<br/>Faster processing<br/>Cost effective]
    ACHECK -->|Small Files<br/>Complex Writing| AOPENAI[ğŸ”µ Select OpenAI<br/>Better precision<br/>for complex handwriting]
    
    %% Processing Attempts
    QOPENAI --> PROCESS1[ğŸš€ Primary Processing]
    QGEMINI --> PROCESS1
    AGEMINI --> PROCESS1  
    AOPENAI --> PROCESS1
    
    PROCESS1 --> VALIDATE1{âœ… Output Valid?}
    
    %% Success Path
    VALIDATE1 -->|âœ… Success| SUCCESS[ğŸ‰ Generated Valid Output]
    
    %% First Retry Path
    VALIDATE1 -->|âŒ Failed| RETRY1{ğŸ”„ Retry Available?}
    RETRY1 -->|Yes| SWITCH1[ğŸ”„ Switch AI Model<br/>OpenAI â†” Gemini]
    SWITCH1 --> PROCESS2[ğŸš€ Secondary Processing<br/>Enhanced Prompts]
    
    PROCESS2 --> VALIDATE2{âœ… Output Valid?}
    VALIDATE2 -->|âœ… Success| SUCCESS
    
    %% Second Retry Path  
    VALIDATE2 -->|âŒ Failed| RETRY2{ğŸ”„ Enhanced Methods?}
    RETRY2 -->|Yes| ENHANCED[ğŸ”§ Enhanced Processing<br/>Simplified Prompts<br/>Better Preprocessing]
    ENHANCED --> PROCESS3[ğŸš€ Enhanced Processing]
    
    PROCESS3 --> VALIDATE3{âœ… Output Valid?}
    VALIDATE3 -->|âœ… Success| SUCCESS
    
    %% Fallback Path
    VALIDATE3 -->|âŒ Failed| FALLBACK[ğŸ›¡ï¸ Structured Fallback<br/>Create Professional Document<br/>Include Available Content]
    RETRY1 -->|No| FALLBACK
    RETRY2 -->|No| FALLBACK
    
    FALLBACK --> GUARANTEED[ğŸ“„ Guaranteed PDF Output<br/>With Diagnostic Information]
    
    %% Final Output
    SUCCESS --> OUTPUT[ğŸ“Š Display Results<br/>3-Panel View<br/>Download Options]
    GUARANTEED --> OUTPUT
    
    %% Error Logging Throughout
    VALIDATE1 -.-> LOG[ğŸ“ Log Performance<br/>Track Success Rates<br/>Model Effectiveness]
    VALIDATE2 -.-> LOG
    VALIDATE3 -.-> LOG
    
    %% Model Selection Factors (Side Info)
    subgraph "ğŸ§  Selection Factors"
        FACTORS[ğŸ“Š File Size: MB<br/>ğŸ“ Pages: Count<br/>ğŸ¨ Quality: Low/Med/High<br/>ğŸ“ Type: Question/Answer<br/>ğŸ§© Complexity: Simple/Complex<br/>ğŸ’° Cost: Optimization]
    end
    
    ANALYZE -.-> FACTORS
    
    %% Styling
    style START fill:#e1f5fe
    style ANALYZE fill:#e8f5e8
    style SUCCESS fill:#c8e6c9
    style GUARANTEED fill:#fff3e0
    style OUTPUT fill:#f3e5f5
    style FALLBACK fill:#ffecb3
    style LOG fill:#fce4ec
    
    %% Model selection styling
    style QOPENAI fill:#e3f2fd
    style AOPENAI fill:#e3f2fd
    style QGEMINI fill:#e8f5e8
    style AGEMINI fill:#e8f5e8
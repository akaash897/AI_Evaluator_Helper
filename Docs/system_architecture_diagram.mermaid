graph TB
    subgraph "🌐 User Interface Layer"
        UI[Web Interface<br/>File Upload & Selection]
        CONFIG[Model Configuration<br/>OpenAI/Gemini Preference]
    end
    
    subgraph "🎯 Agentic Orchestration Layer"
        ORCH[ExamProcessingOrchestrator<br/>Workflow Coordination]
        
        subgraph "🤖 Intelligent Agents"
            DOC[DocumentAnalyzer<br/>📊 Quality Assessment<br/>🧠 Model Selection]
            QUEST[QuestionExtractor<br/>📋 Question Identification<br/>✅ Content Validation]
            ANS[AnswerProcessor<br/>📝 Handwriting Recognition<br/>🔗 Question-Answer Mapping]
            LATEX[LatexCompiler<br/>⚙️ PDF Generation<br/>🔧 Error Recovery]
        end
    end
    
    subgraph "🧠 AI Model Layer"
        OPENAI[OpenAI GPT-4V<br/>🎯 High Precision<br/>📄 Structured Text]
        GEMINI[Google Gemini 2.0<br/>⚡ Fast Processing<br/>✍️ Handwriting OCR]
    end
    
    subgraph "🛡️ Fallback System"
        ENHANCED[Enhanced Methods<br/>📈 Better Prompts<br/>🔄 Retry Logic]
        LEGACY[Legacy Processing<br/>🔧 Original Methods<br/>📄 Basic Extraction]
        EMERGENCY[Emergency Fallback<br/>📋 Structured Documents<br/>🚨 Error Reports]
    end
    
    subgraph "💾 Storage & Output"
        TEMP[Temporary Storage<br/>🖼️ Image Conversion<br/>📁 Processing Files]
        OUTPUT[Final Output<br/>📄 Generated PDFs<br/>📊 Results Display]
        META[Metadata<br/>📋 File Organization<br/>📈 Success Tracking]
    end
    
    %% Main Flow
    UI --> ORCH
    CONFIG --> ORCH
    ORCH --> DOC
    DOC --> QUEST
    QUEST --> ANS
    ANS --> LATEX
    
    %% AI Model Connections
    DOC -.->|Intelligent Selection| OPENAI
    DOC -.->|Intelligent Selection| GEMINI
    QUEST -.->|Dynamic Choice| OPENAI
    QUEST -.->|Dynamic Choice| GEMINI
    ANS -.->|Adaptive Processing| OPENAI
    ANS -.->|Adaptive Processing| GEMINI
    
    %% Fallback Connections
    QUEST -.->|If AI Fails| ENHANCED
    ANS -.->|If AI Fails| ENHANCED
    ENHANCED -.->|If Enhanced Fails| LEGACY
    LEGACY -.->|If All Fails| EMERGENCY
    
    %% Storage Connections
    ORCH --> TEMP
    LATEX --> OUTPUT
    ORCH --> META
    
    %% Success Path
    LATEX --> UI
    
    %% Styling
    classDef agent fill:#e8f5e8,stroke:#4caf50,stroke-width:2px
    classDef ai fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
    classDef fallback fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    classDef storage fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    classDef ui fill:#e1f5fe,stroke:#00bcd4,stroke-width:2px
    
    class DOC,QUEST,ANS,LATEX agent
    class OPENAI,GEMINI ai
    class ENHANCED,LEGACY,EMERGENCY fallback
    class TEMP,OUTPUT,META storage
    class UI,CONFIG ui